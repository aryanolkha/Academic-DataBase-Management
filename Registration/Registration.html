<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Registration</title>
    <style>
        label {
            font-weight: bold;
        }

        input[type="text"],
        select,
        input[type="submit"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="submit"] {
            background-color: #4caf50;
            color: white;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background-color: #45a049;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <h1>Course Registration - Semester <span id="semesterNumber"></span></h1>

    <form id="registrationForm">
        <input type="hidden" id="semester" name="semester" value="">

        <label for="Student_ID">Student ID:</label>
        <input type="text" id="Student_ID" name="Student_ID" required><br><br>

        <label for="Department">Select Department:</label>
        <select name="Department" id="Department" required>
            <option value="">Select Department</option>
            <option value="CSE">Computer Science and Engineering</option>
            <option value="MNC">Mathematics and Computing</option>
            <option value="EE">Electrical Engineering</option>
            <option value="ME">Mechanical Engineering</option>
        </select><br><br>

        <table id="coursesTable">
            <thead>
                <tr>
                    <th>Course Code</th>
                    <th>Course Type</th>
                    <th>Instructor Name</th>
                    <th>Email</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody id="coursesBody"></tbody>
        </table>

        <input type="submit" value="Register">
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = sessionStorage.getItem('username');
            const semester = urlParams.get('semester');
            document.getElementById('semester').value = semester;
            document.getElementById('semesterNumber').textContent = semester;

            const registrationForm = document.getElementById("registrationForm");
            const coursesBody = document.getElementById("coursesBody");
            const coursesTable = document.getElementById("coursesTable");

            const studentIdInput = document.getElementById('Student_ID');
            if (studentId) {
                // Student ID found in session storage
                console.log('Student ID:', studentId);
                // Fill the input field with the student ID
                studentIdInput.value = studentId;
                studentIdInput.readOnly = true;

                // Fetch student profile data from the backend
                fetch(`http://localhost:5000/get-student-profile?studentId=${studentId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Student Profile:', data);
                        // Check if department is available in the profile data
                        if (data.department) {
                            // Set the department value in the select dropdown
                            Department.value = data.department;
                            Department.disabled = true;
                        } else {
                            console.log('Department not found in student profile');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching student profile:', error);
                    });
            } else {
                // Student ID not found in session storage
                console.log('Student ID not found in session storage');
            }


            registrationForm.addEventListener("submit", function (event) {
                event.preventDefault();

                // const studentID = document.getElementById("Student_ID").value;
                const department = document.getElementById("Department").value;
                const semesterNumber = document.getElementById("semester").value;

                fetch(`http://localhost:5000/get-reg-courses?Department=${department}&Semester=${semesterNumber}&Student_ID=${studentId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Fetched courses:", data.courses);
                        coursesBody.innerHTML = "";
                        data.courses.forEach(course => {
                            const { Course_Code, Course_Type, Instructor_Name, Email } = course;
                            const row = `
                <tr>
                  <td>${Course_Code}</td>
                  <td>${Course_Type}</td>
                  <td>${Instructor_Name}</td>
                  <td>${Email}</td>
                  <td><input type="checkbox" name="selectedCourses" value="${Course_Code}"></td>
                </tr>`;
                            coursesBody.innerHTML += row;
                        });
                        coursesTable.style.display = "table";
                    })
                    .catch(error => {
                        console.error("Error fetching courses:", error);
                        alert("Failed to fetch courses. Please try again.");
                    });
            });
        });
    </script>
</body>

</html>